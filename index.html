<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ AI ä¼´è¯»è½¯ä»¶</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        /* ã€æ”¹åŠ¨ 1ã€‘å°†é˜…è¯»åŒºæ¯”ä¾‹è°ƒå¤§ï¼ˆflex: 8ï¼‰ */
        #reader-container { flex: 8; background-color: #fcfcfa; padding: 20px 40px; display: flex; flex-direction: column; }
        #controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: space-between; }
        
        #viewer {
            flex-grow: 1; 
            width: 100%; 
            height: 100%;
            border: 1px dashed #ccc;
            border-radius: 8px;
            overflow: hidden; 
            position: relative; 
        }
        #viewer iframe { max-width: 100% !important; }

        /* ã€æ”¹åŠ¨ 2ã€‘å°† AI ä¾§è¾¹æ æ¯”ä¾‹è°ƒå°ï¼ˆflex: 2ï¼‰ï¼Œå¹¶è®¾ç½®æœ€å°å®½åº¦ä¿è¯å¯ç”¨æ€§ */
        #ai-sidebar { flex: 2; min-width: 300px; background-color: #ffffff; border-left: 2px solid #eaeaea; padding: 20px; display: flex; flex-direction: column; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
        #input-area { display: flex; gap: 10px; flex-direction: column; }
        
        #selection-tip { font-size: 12px; color: #666; margin-bottom: 5px; display: none; }
        
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <div id="reader-container">
        <div id="controls">
            <div><input type="file" id="book-upload" accept=".epub"></div>
            <div>
                <button id="prev-btn">ä¸Šä¸€é¡µ</button>
                <button id="next-btn">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
        <div id="viewer"></div>
    </div> <div id="ai-sidebar">
        <h2>ğŸ¤– AI ä¼´è¯»åŠ©æ‰‹</h2>
        <div id="chat-history">
            <p><strong>AI:</strong> ä½ å¥½ï¼è¯•ç€åœ¨å·¦è¾¹ä¹¦é‡Œç”¨é¼ æ ‡åˆ’é€‰ä¸€æ®µæ–‡å­—ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
        </div>
        <div id="input-area">
            <span id="selection-tip">å·²è‡ªåŠ¨å¼•ç”¨åŸæ–‡ï¼Œè¯·åœ¨ä¸‹æ–¹æé—®ï¼š</span>
            <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜...">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <script>
        /* === å³ä¾§èŠå¤©é€»è¾‘ === */
        const sendBtn = document.getElementById('send-btn');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const selectionTip = document.getElementById('selection-tip');

        sendBtn.addEventListener('click', async function() {
            const text = userInput.value;
            if (text === "") return;

            // 1. å…ˆæŠŠä½ å‘çš„æ¶ˆæ¯æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
            const userMessage = document.createElement('p');
            userMessage.innerHTML = '<strong>ä½ :</strong> ' + text;
            chatHistory.appendChild(userMessage);
            
            // æå–åŸæ–‡å’Œé—®é¢˜ï¼ˆè¿™é‡Œåšä¸ªç®€å•çš„æ‹†åˆ†ï¼ŒæŠŠâ€œã€å¼•ç”¨åŸæ–‡ã€‘â€çš„å†…å®¹å•ç‹¬æå–å‡ºæ¥ï¼‰
            let originalText = "";
            let question = text;
            if(text.includes("ã€å¼•ç”¨åŸæ–‡ã€‘")){
                originalText = text.substring(text.indexOf('ï¼š') + 1, text.indexOf(' \n\næˆ‘çš„é—®é¢˜æ˜¯ï¼š'));
                question = text.substring(text.indexOf(' \n\næˆ‘çš„é—®é¢˜æ˜¯ï¼š') + 10);
            }

            userInput.value = "";
            selectionTip.style.display = 'none';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // 2. æ˜¾ç¤ºâ€œAI æ­£åœ¨æ€è€ƒâ€çš„å ä½ç¬¦
            const aiMessage = document.createElement('p');
            aiMessage.innerHTML = '<strong>AI:</strong> ğŸ§  æ­£åœ¨æ€è€ƒä¸­...';
            chatHistory.appendChild(aiMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // 3. ã€æ–°åŠŸèƒ½ã€‘é€šè¿‡ç½‘ç»œæŠŠæ•°æ®æ‰“åŒ…å‘é€ç»™ Python åç«¯
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_text: originalText,
                        question: question
                    })
                });
                
                const result = await response.json();
                
              // 4. æ”¶åˆ°åç«¯é€å›æ¥çš„ç­”æ¡ˆå
if (result.status === "success") {
    // ä½¿ç”¨ marked åº“å°† Markdown æ–‡æœ¬è½¬æ¢æˆæ¼‚äº®çš„ HTML
    // åŒæ—¶è®¾ç½® breaks: true è®©æ¢è¡Œç¬¦ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º
    const formattedReply = marked.parse(result.reply, { breaks: true });
    aiMessage.innerHTML = '<strong>AI:</strong> ' + formattedReply;
} else {
    aiMessage.innerHTML = '<strong>AI:</strong> âŒ æŠ¥é”™äº†ï¼š' + result.reply;
}
            } catch (error) {
                aiMessage.innerHTML = '<strong>AI:</strong> âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ï¼Œè¯·ç¡®è®¤ app.py æ˜¯å¦å·²ç»è¿è¡Œï¼';
            }
            
            chatHistory.scrollTop = chatHistory.scrollHeight;
        });

        /* === å·¦ä¾§é˜…è¯»å™¨åŠåˆ’è¯è”åŠ¨é€»è¾‘ === */
        const uploadInput = document.getElementById('book-upload');
        const viewer = document.getElementById('viewer'); 
        let book;
        let rendition;

        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const bookData = event.target.result;
                if (book) book.destroy(); 
                viewer.innerHTML = ''; 

                book = ePub(bookData);
                const viewerWidth = viewer.offsetWidth;

                rendition = book.renderTo("viewer", {
                    width: viewerWidth, 
                    height: "100%",
                    spread: "none"
                });
                
                rendition.display();

                // ç›‘å¬åˆ’è¯è”åŠ¨
                rendition.on('selected', function(cfiRange, contents) {
                    const range = rendition.getRange(cfiRange);
                    const selectedText = range.toString();
                    
                    userInput.value = `ã€å¼•ç”¨åŸæ–‡ã€‘ï¼š"${selectedText}" \n\næˆ‘çš„é—®é¢˜æ˜¯ï¼š`;
                    selectionTip.style.display = 'block';
                    userInput.focus();
                });
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('next-btn').addEventListener('click', () => rendition && rendition.next());
        document.getElementById('prev-btn').addEventListener('click', () => rendition && rendition.prev());
        
        window.addEventListener('resize', function(){
            if(rendition) {
                const viewerWidth = viewer.offsetWidth;
                rendition.resize(viewerWidth, "100%");
            }
        });
    </script>

</body>
</html>