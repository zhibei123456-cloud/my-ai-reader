<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ AI ä¼´è¯»è½¯ä»¶</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        /* ã€æ”¹åŠ¨ 1ã€‘å°†é˜…è¯»åŒºæ¯”ä¾‹è°ƒå¤§ï¼ˆflex: 8ï¼‰ */
        #reader-container { flex: 8; background-color: #fcfcfa; padding: 20px 40px; display: flex; flex-direction: column; }
        #controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: space-between; }
        
        #viewer {
            flex-grow: 1; 
            width: 100%; 
            height: 100%;
            border: 1px dashed #ccc;
            border-radius: 8px;
            overflow: hidden; 
            position: relative; 
        }
        #viewer iframe { max-width: 100% !important; }

        /* ã€æ”¹åŠ¨ 2ã€‘å°† AI ä¾§è¾¹æ æ¯”ä¾‹è°ƒå°ï¼ˆflex: 2ï¼‰ï¼Œå¹¶è®¾ç½®æœ€å°å®½åº¦ä¿è¯å¯ç”¨æ€§ */
        #ai-sidebar { flex: 2; min-width: 300px; background-color: #ffffff; border-left: 2px solid #eaeaea; padding: 20px; display: flex; flex-direction: column; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
        #input-area { display: flex; gap: 10px; flex-direction: column; }
        
        #selection-tip { font-size: 12px; color: #666; margin-bottom: 5px; display: none; }
        
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <div id="reader-container">
        <div id="controls">
            <div><input type="file" id="book-upload" accept=".epub"></div>
            <div>
                <button id="prev-btn">ä¸Šä¸€é¡µ</button>
                <button id="next-btn">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
        <div id="viewer"></div>
    </div> <div id="ai-sidebar">
        <h2>ğŸ¤– AI ä¼´è¯»åŠ©æ‰‹</h2>
        <div id="chat-history">
            <p><strong>AI:</strong> ä½ å¥½ï¼è¯•ç€åœ¨å·¦è¾¹ä¹¦é‡Œç”¨é¼ æ ‡åˆ’é€‰ä¸€æ®µæ–‡å­—ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
        </div>
        <div id="input-area">
            <span id="selection-tip">å·²è‡ªåŠ¨å¼•ç”¨åŸæ–‡ï¼Œè¯·åœ¨ä¸‹æ–¹æé—®ï¼š</span>
            <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜...">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <script>
        /* === å…¨å±€å˜é‡ === */
        let currentSelectedText = "";

        /* === å³ä¾§èŠå¤©é€»è¾‘ï¼ˆå·²ä¼˜åŒ–ï¼‰ === */
        const sendBtn = document.getElementById('send-btn');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const selectionTip = document.getElementById('selection-tip');

        // å›è½¦å‘é€
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        sendBtn.addEventListener('click', async function() {
            const question = userInput.value.trim();
            if (question === "") return;

            // æ˜¾ç¤ºç”¨æˆ·çš„é—®é¢˜ï¼ˆå¹²å‡€ï¼ï¼‰
            const userMessage = document.createElement('p');
            userMessage.innerHTML = `<strong>ä½ :</strong> ${question}`;
            if (currentSelectedText) {
                userMessage.innerHTML += ` <small style="color:#888">(å¼•ç”¨äº† ${currentSelectedText.length} å­—åŸæ–‡)</small>`;
            }
            chatHistory.appendChild(userMessage);

            // ä¿å­˜æœ¬æ¬¡åŸæ–‡å¹¶æ¸…ç©ºå…¨å±€å˜é‡
            const thisSelectedText = currentSelectedText;
            currentSelectedText = "";

            userInput.value = "";
            selectionTip.style.display = 'none';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // æ€è€ƒä¸­
            const aiMessage = document.createElement('p');
            aiMessage.innerHTML = '<strong>AI:</strong> ğŸ§  æ­£åœ¨æ€è€ƒä¸­...';
            chatHistory.appendChild(aiMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_text: thisSelectedText,
                        question: question
                    })
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    const formattedReply = marked.parse(result.reply, { breaks: true });
                    aiMessage.innerHTML = '<strong>AI:</strong> ' + formattedReply;
                } else {
                    aiMessage.innerHTML = '<strong>AI:</strong> âŒ ' + result.reply;
                }
            } catch (error) {
                aiMessage.innerHTML = '<strong>AI:</strong> âŒ æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ app.py å·²è¿è¡Œï¼';
            }
            
            chatHistory.scrollTop = chatHistory.scrollHeight;
        });

        /* === å·¦ä¾§é˜…è¯»å™¨ & åˆ’è¯ï¼ˆå·²ä¼˜åŒ–ï¼‰ === */
        const uploadInput = document.getElementById('book-upload');
        const viewer = document.getElementById('viewer'); 
        let book;
        let rendition;

        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const bookData = event.target.result;
                if (book) book.destroy(); 
                viewer.innerHTML = ''; 

                book = ePub(bookData);
                rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    spread: "none"
                });
                
                rendition.display();

                // åˆ’è¯
                rendition.on('selected', function(cfiRange, contents) {
                    const range = rendition.getRange(cfiRange);
                    currentSelectedText = range.toString().trim();
                    
                    const len = currentSelectedText.length;
                    selectionTip.textContent = `å·²é€‰ä¸­ ${len} å­—åŸæ–‡ï¼Œè¯·åœ¨ä¸‹æ–¹æé—®ï¼š`;
                    selectionTip.style.display = 'block';
                    userInput.focus();
                });
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('next-btn').addEventListener('click', () => rendition && rendition.next());
        document.getElementById('prev-btn').addEventListener('click', () => rendition && rendition.prev());
        
        window.addEventListener('resize', () => {
            if (rendition) rendition.resize(viewer.offsetWidth, "100%");
        });
    </script>

</body>
</html>