<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ AI ä¼´è¯»è½¯ä»¶</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        /* ã€æ”¹åŠ¨ 1ã€‘å°†é˜…è¯»åŒºæ¯”ä¾‹è°ƒå¤§ï¼ˆflex: 8ï¼‰ */
        #reader-container { flex: 8; background-color: #fcfcfa; padding: 20px 40px; display: flex; flex-direction: column; }
        #controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: space-between; }
        
        #viewer {
            flex-grow: 1; 
            width: 100%; 
            height: 100%;
            border: 1px dashed #ccc;
            border-radius: 8px;
            overflow: hidden; 
            position: relative; 
        }
        #viewer iframe { max-width: 100% !important; }

        /* ã€æ”¹åŠ¨ 2ã€‘å°† AI ä¾§è¾¹æ æ¯”ä¾‹è°ƒå°ï¼ˆflex: 2ï¼‰ï¼Œå¹¶è®¾ç½®æœ€å°å®½åº¦ä¿è¯å¯ç”¨æ€§ */
        #ai-sidebar { flex: 2; min-width: 300px; background-color: #ffffff; border-left: 2px solid #eaeaea; padding: 20px; display: flex; flex-direction: column; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
        #input-area { display: flex; gap: 10px; flex-direction: column; }
        
        #selection-tip { font-size: 12px; color: #666; margin-bottom: 5px; display: none; }
        
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        /* === é˜²æ­¢é˜…è¯»å™¨å¾€å³æ¨å±å¹•çš„ç»ˆæçº¦æŸ === */
        body { overflow-x: hidden; }

        #reader-container {
            min-width: 0;           /* flex å­é¡¹å…³é”®ï¼é˜²æ­¢è†¨èƒ€ */
            overflow: hidden;
        }

        #viewer {
            min-width: 0;
            overflow: hidden;
            box-sizing: border-box;
        }

        #viewer iframe {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
            border: none !important;
        }

        #ai-sidebar {
            flex-shrink: 0;         /* å³è¾¹æ ä¸è¢«æŒ¤å‹ */
        }
        /* === ç»ˆæé˜²æ¨å± + å†…å­˜å®‰å…¨çº¦æŸ === */
        body { 
            overflow-x: hidden; 
            box-sizing: border-box; 
        }
        #reader-container, #viewer { 
            min-width: 0; 
            flex-shrink: 1; 
            overflow: hidden; 
            box-sizing: border-box; 
        }
        #viewer iframe { 
            width: 100% !important; 
            max-width: 100% !important; 
            height: 100% !important; 
            border: none !important; 
            box-sizing: border-box; 
        }
        #ai-sidebar { flex-shrink: 0; min-width: 300px; }
/* === æ€»ç»“å¡ç‰‡ & é«˜äº®æ ·å¼ === */
.summary-cards { margin: 15px 0; }
.summary-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 12px;
    background: #fff;
    overflow: hidden;
}
.summary-card > summary {
    padding: 12px 15px;
    background: #f1f3f5;
    font-weight: bold;
    cursor: pointer;
    list-style: none;
}
.summary-card > div {
    padding: 15px;
    border-top: 1px solid #eee;
    line-height: 1.7;
}
.summary-card summary:hover { background: #e9ecef; }

.highlight-btn {
    margin-top: 10px;
    padding: 8px 16px;
    background: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}
.highlight-btn:hover { background: #138496; }

/* é«˜äº®æ ‡è®° */
mark {
    background: #ffeb3b !important;
    padding: 2px 4px;
    border-radius: 3px;
}
/* === é˜…è¯»è®¾ç½®é¢æ¿ === */
#settings-btn { background:#6c757d; }
#settings-panel {
    position: fixed; right: -320px; top: 0; bottom: 0; width: 320px;
    background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    transition: right 0.3s ease; z-index: 1000; padding: 20px; overflow-y: auto;
    border-left: 1px solid #ddd;
}
#settings-panel.open { right: 0; }
#settings-panel h3 { margin-top: 0; }
.setting-item { margin-bottom: 18px; }
.setting-item label { display: block; margin-bottom: 6px; font-weight: bold; }
input[type="range"] { width: 100%; }
input[type="color"] { width: 60px; height: 30px; vertical-align: middle; }
.theme-btn {
    padding: 8px 16px; margin: 4px; border: none; border-radius: 6px; cursor: pointer;
}
#close-settings { float: right; font-size: 20px; cursor: pointer; }
/* === é˜²æ–‡å­—å‡ºæ ¼ + è¡Œè·å¼ºåˆ¶ç”Ÿæ•ˆ === */
#viewer, #viewer iframe {
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    overflow: hidden !important;
    box-sizing: border-box;
}

#viewer iframe {
    border: none !important;
}

#viewer iframe body,
#viewer iframe p,
#viewer iframe div,
#viewer iframe span {
    max-width: 100% !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
}
    </style>
</head>
<body>

    <div id="reader-container">
<div id="controls">
    <div><input type="file" id="book-upload" accept=".epub"></div>
    <div style="display:flex; gap:8px; align-items:center;">
        <button id="prev-btn">ä¸Šä¸€é¡µ</button>
        <button id="next-btn">ä¸‹ä¸€é¡µ</button>
        
        <select id="summary-mode" style="padding:8px 12px; border-radius:4px; border:1px solid #ccc;">
            <option value="current">ğŸ“„ å½“å‰é¡µ</option>
            <option value="last3">ğŸ“š æœ€è¿‘3é¡µ</option>
            <option value="chapter">ğŸ“– æœ¬ç« å®Œæ•´</option>
        </select>
        
        <button id="summary-btn" style="background-color:#28a745;">ğŸ“ ä¸€é”®æ€»ç»“</button>
        <button id="settings-btn" style="background:#6c757d;color:white;" title="é˜…è¯»è®¾ç½®">âš™ï¸ è®¾ç½®</button>
    </div>
</div>
<!-- ç¾è§‚é˜…è¯»è®¾ç½®å¼¹çª— -->
<div id="settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:white; width:380px; border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">ğŸ“– é˜…è¯»è®¾ç½®</h3>
            <span id="close-modal" style="font-size:24px; cursor:pointer; color:#999;">âœ•</span>
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold;">å­—ä½“å¤§å° <span id="font-size-val">18</span>px</label>
            <input type="range" id="font-size" min="12" max="32" value="18" step="1" style="width:100%;">
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold;">è¡Œè· <span id="line-height-val">1.6</span></label>
            <input type="range" id="line-height" min="1.0" max="2.5" value="1.6" step="0.1" style="width:100%;">
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold;">é¡µè¾¹è· <span id="margin-val">40</span>px</label>
            <input type="range" id="margin" min="0" max="80" value="40" step="2" style="width:100%;">
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold;">ä¸»é¢˜</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="theme-btn" data-theme="light" style="flex:1; padding:10px; background:#f8f9fa; color:#333; border:1px solid #ddd; border-radius:6px;">æµ…è‰²</button>
                <button class="theme-btn" data-theme="dark" style="flex:1; padding:10px; background:#1e1e1e; color:#eee; border:1px solid #ddd; border-radius:6px;">å¤œé—´</button>
                <button class="theme-btn" data-theme="eye" style="flex:1; padding:10px; background:#e6f0d6; color:#333; border:1px solid #ddd; border-radius:6px;">æŠ¤çœ¼ç»¿</button>
                <button id="custom-color-btn" style="flex:1; padding:10px; background:#fff; border:1px solid #ddd; border-radius:6px;">è‡ªå®šä¹‰é¢œè‰²</button>
                <input type="color" id="custom-bg" value="#f8f9fa" style="display:none;">
            </div>
        </div>
    </div>
</div>
        <div id="viewer"></div>
    </div> <div id="ai-sidebar">
        <h2>ğŸ¤– AI ä¼´è¯»åŠ©æ‰‹</h2>
        <div id="chat-history">
            <p><strong>AI:</strong> ä½ å¥½ï¼è¯•ç€åœ¨å·¦è¾¹ä¹¦é‡Œç”¨é¼ æ ‡åˆ’é€‰ä¸€æ®µæ–‡å­—ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
        </div>
        <div id="input-area">
            <span id="selection-tip">å·²è‡ªåŠ¨å¼•ç”¨åŸæ–‡ï¼Œè¯·åœ¨ä¸‹æ–¹æé—®ï¼š</span>
            <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜...">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

<script>
    let currentSelectedText = "";
    let lastPageTexts = [];

    /* === èŠå¤©é€»è¾‘ === */
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const chatHistory = document.getElementById('chat-history');
    const selectionTip = document.getElementById('selection-tip');

    userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendBtn.click(); });
    sendBtn.addEventListener('click', async () => await sendToAI(userInput.value.trim(), currentSelectedText, false));

    /* === ä¸€é”®æ€»ç»“ï¼ˆä¿æŒä¸å˜ï¼‰=== */
    const summaryBtn = document.getElementById('summary-btn');
    const summaryMode = document.getElementById('summary-mode');

    summaryBtn.addEventListener('click', async () => {
        if (!rendition) { alert('è¯·å…ˆæ‰“å¼€ä¸€æœ¬ä¹¦ï¼'); return; }
        summaryBtn.disabled = true;
        summaryBtn.textContent = summaryMode.value === 'chapter' ? 'â³ æ­£åœ¨æå–å®Œæ•´ç« èŠ‚...' : 'â³ æ­£åœ¨æå–å¹¶æ€»ç»“...';

        let pageText = '';
        if (summaryMode.value === 'current') pageText = await getCurrentPageText();
        else if (summaryMode.value === 'last3') pageText = lastPageTexts.length ? lastPageTexts.join('\n\n') : await getCurrentPageText();
        else if (summaryMode.value === 'chapter') pageText = await getCurrentChapterText();

        if (pageText.length < 50) {
            alert('å½“å‰å†…å®¹å¤ªå°‘ï¼Œè¯·ç¿»é¡µåé‡è¯•ï½');
            summaryBtn.disabled = false;
            summaryBtn.textContent = 'ğŸ“ ä¸€é”®æ€»ç»“';
            return;
        }
        if (pageText.length > 7500) pageText = pageText.substring(0, 7500) + '\nï¼ˆå·²æˆªæ–­ï¼‰';

        const summaryQuestion = "è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆæ¯æ®µä¸€ä¸ªå¡ç‰‡ï¼‰ï¼š\n1. ã€ç¬¬1æ®µå¤§æ„ã€‘xxx\nä¸å‰æ–‡è”ç³»ï¼šxxx\n2. ã€ç¬¬2æ®µå¤§æ„ã€‘xxx\nä¸å‰æ–‡è”ç³»ï¼šxxx\n...\næœ€åç”¨ä¸€å¥è¯æ€»ç»“æœ¬é¡µ/è¿™å‡ é¡µåœ¨å…¨ä¹¦ä¸­çš„ä½œç”¨ã€‚";
        await sendToAI(summaryQuestion, pageText, true);

        summaryBtn.disabled = false;
        summaryBtn.textContent = 'ğŸ“ ä¸€é”®æ€»ç»“';
    });

    /* === é˜…è¯»å™¨æ ¸å¿ƒ === */
    const uploadInput = document.getElementById('book-upload');
    const viewer = document.getElementById('viewer');
    let book = null;
    let rendition = null;

    function forceResize() {
        if (rendition) rendition.resize(Math.max(viewer.clientWidth, 600), Math.max(viewer.clientHeight, 400));
    }

    function cacheCurrentPage() {
        getCurrentPageText().then(text => {
            if (text.length > 30) {
                lastPageTexts.push(text);
                if (lastPageTexts.length > 3) lastPageTexts.shift();
            }
        });
    }

    uploadInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        viewer.innerHTML = '<div style="text-align:center;padding-top:100px;color:#666;">ğŸ“– æ­£åœ¨åŠ è½½...</div>';

        const reader = new FileReader();
        reader.onload = function(event) {
            if (book) book.destroy();
            if (rendition) rendition.destroy();
            viewer.innerHTML = '';

            book = ePub(event.target.result);
          rendition = book.renderTo("viewer", {
    width: "100%", 
    height: "100%", 
    spread: "none",           // å¼ºåˆ¶å•é¡µ
    minSpreadWidth: 0,        // å½»åº•ç¦æ­¢åŒé¡µ
    flow: "paginated", 
    contained: true
});
            rendition.display().then(() => {
                setTimeout(() => {
                    loadReadingSettings();
                    applyReadingSettings();
                    bindRenditionEvents();
                }, 400);   // å¢åŠ å»¶è¿Ÿï¼Œä¿è¯ iframe å®Œå…¨åŠ è½½
            });

            rendition.on('selected', function(cfiRange) {
                const range = rendition.getRange(cfiRange);
                currentSelectedText = range.toString().trim();
                const len = currentSelectedText.length;
                selectionTip.textContent = `å·²é€‰ä¸­ ${len} å­—åŸæ–‡ï¼Œè¯·åœ¨ä¸‹æ–¹æé—®ï¼š`;
                selectionTip.style.display = 'block';
                userInput.focus();
                setTimeout(() => window.getSelection().removeAllRanges(), 100);
            });
        };
        reader.readAsArrayBuffer(file);
    });

    document.getElementById('next-btn').addEventListener('click', () => rendition && rendition.next().then(() => { forceResize(); setTimeout(cacheCurrentPage, 800); }));
    document.getElementById('prev-btn').addEventListener('click', () => rendition && rendition.prev().then(() => { forceResize(); setTimeout(cacheCurrentPage, 800); }));
    window.addEventListener('resize', () => requestAnimationFrame(forceResize));

    /* === é€šç”¨å‘é€å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰=== */
    async function sendToAI(question, selectedText = "", isSummary = false) {
        if (!question) return;
        const userMessage = document.createElement('p');
        userMessage.innerHTML = `<strong>ä½ :</strong> ${question}`;
        chatHistory.appendChild(userMessage);

        const aiMessage = document.createElement('p');
        aiMessage.innerHTML = '<strong>AI:</strong> ğŸ§  æ­£åœ¨æ€è€ƒä¸­...';
        chatHistory.appendChild(aiMessage);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        try {
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_text: selectedText, question: question })
            });
            const result = await response.json();
            if (result.status === "success") {
                let html = marked.parse(result.reply, { breaks: true });
                if (isSummary) {
                    html = '<div class="summary-cards">' + result.reply.split(/\n(?=\d+\.)/).map(section => {
                        return `<details class="summary-card"><summary>${section.split('\n')[0]}</summary><div>${marked.parse(section)}</div></details>`;
                    }).join('') + '</div>';
                    html += `<button class="highlight-btn" onclick="highlightCurrentPage(this)">ğŸ”¦ é«˜äº®åŸæ–‡å…³é”®å¥</button>`;
                }
                aiMessage.innerHTML = `<strong>AI:</strong> ${html}`;
            } else {
                aiMessage.innerHTML = `<strong>AI:</strong> âŒ ${result.reply}`;
            }
        } catch (e) {
            aiMessage.innerHTML = '<strong>AI:</strong> âŒ æ— æ³•è¿æ¥åç«¯ï¼';
        }
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    /* === é«˜äº® & æ–‡æœ¬å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰=== */
    window.highlightCurrentPage = function(btn) { /* åŸæ ·ä¿ç•™ */ 
        const contents = rendition.getContents();
        const summaryText = btn.parentElement.textContent;
        const keySentences = summaryText.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.length > 8).map(s => s.trim());
        contents.forEach(content => {
            if (content?.document?.body) {
                let html = content.document.body.innerHTML;
                keySentences.forEach(s => {
                    const escaped = s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    html = html.replace(new RegExp(escaped, 'gi'), m => `<mark>${m}</mark>`);
                });
                content.document.body.innerHTML = html;
            }
        });
        btn.textContent = 'âœ… å·²é«˜äº®ï¼ˆåˆ·æ–°æ¸…é™¤ï¼‰';
        btn.disabled = true;
    };

    async function getCurrentPageText() {
        let text = '';
        rendition.getContents().forEach(c => {
            if (c?.document?.body) text += c.document.body.innerText.trim() + '\n\n';
        });
        return text.trim();
    }

    async function getCurrentChapterText() {
        if (!book || !rendition?.location) return await getCurrentPageText();
        try {
            const section = book.spine.get(rendition.location.start.cfi);
            if (section) {
                const html = await section.render();
                const div = document.createElement('div');
                div.innerHTML = html;
                return div.innerText.trim();
            }
        } catch (e) {}
        return await getCurrentPageText();
    }

    /* === é˜…è¯»è®¾ç½® - ç»ˆæç‰ˆï¼ˆå·²éªŒè¯æœ‰æ•ˆï¼‰=== */
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeModal = document.getElementById('close-modal');

    const fontSizeSlider = document.getElementById('font-size');
    const lineHeightSlider = document.getElementById('line-height');
    const marginSlider = document.getElementById('margin');
    const fontSizeVal = document.getElementById('font-size-val');
    const lineHeightVal = document.getElementById('line-height-val');
    const marginVal = document.getElementById('margin-val');

    let currentTheme = 'light';
    let customBgColor = '#f8f9fa';

    settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
    closeModal.addEventListener('click', () => settingsModal.style.display = 'none');
    settingsModal.addEventListener('click', e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; });

    function updateAndApply() {
        fontSizeVal.textContent = fontSizeSlider.value;
        lineHeightVal.textContent = lineHeightSlider.value;
        marginVal.textContent = marginSlider.value;
        applyReadingSettings();
    }
    fontSizeSlider.addEventListener('input', updateAndApply);
    lineHeightSlider.addEventListener('input', updateAndApply);
    marginSlider.addEventListener('input', updateAndApply);

    document.querySelectorAll('.theme-btn[data-theme]').forEach(btn => {
        btn.addEventListener('click', () => { currentTheme = btn.dataset.theme; updateAndApply(); });
    });
    document.getElementById('custom-color-btn').addEventListener('click', () => document.getElementById('custom-bg').click());
    document.getElementById('custom-bg').addEventListener('input', e => {
        customBgColor = e.target.value;
        currentTheme = 'custom';
        updateAndApply();
    });

   function applyReadingSettings() {
    if (!rendition) return;

    const fs = fontSizeSlider.value + 'px';
    const lh = lineHeightSlider.value;
    const mg = marginSlider.value + 'px';

    let bg = '#f8f9fa', color = '#333333';
    if (currentTheme === 'dark') { bg = '#1e1e1e'; color = '#eeeeee'; }
    else if (currentTheme === 'eye') { bg = '#e6f0d6'; color = '#333333'; }
    else if (currentTheme === 'custom') { bg = customBgColor; color = '#333333'; }

    // å¼ºåˆ¶å•é¡µæ¨¡å¼ï¼ˆé˜²æ­¢å·å·å˜åŒé¡µï¼‰
    rendition.spread("none");

    // 1. themes æ³¨å…¥
    rendition.themes.register('custom-theme', {
        'body': { 'background-color': bg, 'color': color, 'font-family': 'Georgia, "Noto Serif SC", serif' }
    });
    rendition.themes.select('custom-theme');

    // 2. ç›´æ¥æ“ä½œ iframe æ ¹èŠ‚ç‚¹ï¼ˆæœ€å¼ºæ–¹å¼ï¼‰
    const iframe = viewer.querySelector('iframe');
    if (iframe && iframe.contentDocument && iframe.contentDocument.documentElement) {
        const root = iframe.contentDocument.documentElement;
        root.style.setProperty('font-size', fs, 'important');
        root.style.setProperty('line-height', lh, 'important');
        root.style.setProperty('padding-left', mg, 'important');
        root.style.setProperty('padding-right', mg, 'important');
        root.style.setProperty('background-color', bg, 'important');
        root.style.setProperty('color', color, 'important');
        root.style.setProperty('max-width', '100%', 'important');
        root.style.setProperty('box-sizing', 'border-box', 'important');
    }

    // 3. å¯¹æ‰€æœ‰å…ƒç´ æ³¨å…¥ï¼ˆè§£å†³è¡Œè·è¢« EPUB å†…éƒ¨ CSS è¦†ç›–ï¼‰
    ['body', 'p', 'div', 'span', 'li', 'h1', 'h2', 'h3', '.epub-view', '.epub-view > div'].forEach(tag => {
        rendition.themes.override(tag, { 
            'font-size': fs, 
            'line-height': lh,
            'padding-left': mg,
            'padding-right': mg
        });
    });

    // 4. å¤šæ¬¡å¼ºåˆ¶é‡ç»˜ï¼ˆè§£å†³å‡ºæ ¼ï¼‰
    rendition.resize(viewer.clientWidth, viewer.clientHeight);
    setTimeout(() => rendition.resize(viewer.clientWidth, viewer.clientHeight), 80);
    setTimeout(() => rendition.resize(viewer.clientWidth, viewer.clientHeight), 200);
    setTimeout(() => rendition.resize(viewer.clientWidth, viewer.clientHeight), 400);

    // ä¿å­˜è®¾ç½®
    localStorage.setItem('readingSettings', JSON.stringify({
        fontSize: fontSizeSlider.value,
        lineHeight: lineHeightSlider.value,
        margin: marginSlider.value,
        theme: currentTheme,
        customBg: customBgColor
    }));
}

    function loadReadingSettings() {
        const saved = localStorage.getItem('readingSettings');
        if (saved) {
            const s = JSON.parse(saved);
            fontSizeSlider.value = s.fontSize || 18;
            lineHeightSlider.value = s.lineHeight || 1.6;
            marginSlider.value = s.margin || 40;
            currentTheme = s.theme || 'light';
            if (s.customBg) {
                customBgColor = s.customBg;
                document.getElementById('custom-bg').value = s.customBg;
            }
            fontSizeVal.textContent = fontSizeSlider.value;
            lineHeightVal.textContent = lineHeightSlider.value;
            marginVal.textContent = marginSlider.value;
        }
    }

    function bindRenditionEvents() {
        if (rendition) {
            rendition.on('relocated', applyReadingSettings);
            rendition.on('rendered', applyReadingSettings);
        }
    }
</script>

</body>
</html>